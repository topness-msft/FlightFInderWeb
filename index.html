<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Flight Finder</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet" />
  <link rel="apple-touch-icon" href="apple-touch-icon.png">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    body {
      font-family: 'Inter', sans-serif;
      background: #f9fafb;
      padding: 20px;
      display: flex;
      justify-content: center;
    } 
    .card {
      background: #ffffff;
      border-radius: 20px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.05);
      max-width: 380px;
      width: 100%;
      padding: 20px;
      text-align: center;
    }
    .airplane-img {
      width: 100%;
      border-radius: 16px;
      margin-bottom: 20px;
    } 
    .info {
      text-align: left;
    }
    .row {
      display: flex;
      gap: 12px;
      align-items: center;
      margin-bottom: 20px;
    }
    .icon {
      background: #f3f4f6;
      padding: 10px;
      border-radius: 12px;
      font-size: 20px;
    }
    .label {
      font-weight: 600;
      font-size: 14px;
      color: #374151;
    }
    .value {
      font-size: 16px;
      color: #111827;
    }
    .error {
      color: #fff;
      text-shadow: 0 2px 8px #000, 0 0 2px #000;
      text-align: center;
      margin-top: 2em;
      font-size: 2em;
      font-weight: bold;
    }
    .loading { text-align: center; color: #2a4d69; margin-top: 2em; }
    #map {
      height: 200px;
      width: 100%;
      border-radius: 12px;
      margin: 24px 0 0 0;
      background: rgba(255,200,200,0.5); /* Debug background */
      border: 2px solid red; /* Debug border */
    }
  </style>
</head>
<body>
  <div class="card" id="flightCard" style="display:none;">
    <img id="flightImg" src="" alt="Aircraft" class="airplane-img" style="display:none;" />
    <div class="info">
      <div class="row">
        <span class="icon">‚úàÔ∏è</span>
        <div>
          <div class="label">Flight</div>
          <div class="value" id="flight"></div>
        </div>
      </div>
      <div class="row">
        <span class="icon">üõ¨</span>
        <div>
          <div class="label">Destination</div>
          <div class="value" id="destination"></div>
        </div>
      </div>
      <div class="row">
        <span class="icon">üõ©Ô∏è</span>
        <div>
          <div class="label">Aircraft</div>
          <div class="value" id="aircraft"></div>
        </div>
      </div>
    </div>
    <div id="map"></div>
  </div>
  <div id="loading" class="loading" style="display:none;">Loading...</div>
  <div id="error" class="error"></div>
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    let apiUrl = "";
    fetch('config.json')
      .then(r => r.json())
      .then(cfg => {
        apiUrl = cfg.apiUrl;
        fetchFlightInfo();
      })
      .catch(() => { document.getElementById('error').textContent = 'Could not load config.json'; });

    async function fetchFlightInfo() {
      document.getElementById('flightCard').style.display = 'none';
      document.getElementById('error').textContent = '';
      document.getElementById('loading').style.display = 'block';
      try {
        if (!apiUrl) throw new Error('API endpoint not loaded.');
        const payload = {};
        const response = await fetch(apiUrl, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload),
        });
        if (!response.ok) {
          let errMsg = `HTTP ${response.status}: ${response.statusText}`;
          try {
            const errData = await response.json();
            if (errData && errData.error) errMsg += ` - ${errData.error}`;
          } catch {}
          throw new Error(errMsg);
        }
        const data = await response.json();
        let flight = data.flight_details || (data.response && data.response.flight_details);
        if (!flight) {
          document.body.style.background = "#b3c6e7 url('https://images.unsplash.com/photo-1464983953574-0892a716854b?auto=format&fit=crop&w=800&q=80') no-repeat center center fixed";
          document.body.style.backgroundSize = 'cover';
          document.getElementById('error').textContent = "Clear skies overhead";
          document.getElementById('map').style.display = 'none';
        } else {
          document.body.style.background = '#f9fafb';
          document.body.style.backgroundImage = '';
          document.getElementById('flight').textContent = ((flight.airline_name || 'Unknown') + ' ' + (flight.flight_number || 'Unknown')).trim();
          document.getElementById('destination').textContent = (flight.destination_name || 'Unknown') + (flight.destination_city ? ', ' + flight.destination_city : '');
          document.getElementById('aircraft').textContent = flight.model_name || 'Unknown';
          if (flight.photo_url) {
            const img = document.getElementById('flightImg');
            img.src = flight.photo_url;
            img.style.display = '';
          } else {
            document.getElementById('flightImg').style.display = 'none';
          }
          // Show map if lat/lon available
          let lat = flight.latitude;
          let lon = flight.longitude;
          if (lat && lon) {
            document.getElementById('flightCard').style.display = '';
            const mapDiv = document.getElementById('map');
            mapDiv.style.display = '';
            mapDiv.innerHTML = "";
            // Wait for browser to render card before initializing map
            requestAnimationFrame(() => {
              setTimeout(() => {
                if (window._leafletMap) {
                  window._leafletMap.remove();
                  window._leafletMap = null;
                }
                window._leafletMap = L.map('map').setView([lat, lon], 10);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                  attribution: '&copy; OpenStreetMap contributors'
                }).addTo(window._leafletMap);
                // Use a custom airplane icon for the marker
                const airplaneIcon = L.icon({
                  iconUrl: 'https://cdn.jsdelivr.net/npm/leaflet.awesome-markers@2.0.5/dist/images/markers/marker-icon-blue.png', // fallback if emoji fails
                  iconSize: [32, 32],
                  iconAnchor: [16, 32],
                  popupAnchor: [0, -32],
                  className: 'airplane-marker',
                  // Use a data URL for an SVG airplane icon
                  iconUrl: 'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 32 32"><text x="16" y="24" font-size="24" text-anchor="middle" alignment-baseline="middle">‚úàÔ∏è</text></svg>'
                });
                L.marker([lat, lon], { icon: airplaneIcon }).addTo(window._leafletMap);
                window._leafletMap.invalidateSize();
              }, 0);
            });
          } else {
            document.getElementById('map').style.display = 'none';
          }
        }
      } catch (err) {
        document.getElementById('error').textContent = "Error: " + err.message;
      } finally {
        document.getElementById('loading').style.display = 'none';
      }
    }
  </script>
</body>
</html>
